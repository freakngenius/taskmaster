<div class="content <%= 'fresh-user' if @list.pristine? %>" data-controller="task-agent sound wakeword keyboard-shortcuts help-modal" data-task-agent-fresh-user-value="<%= @list.pristine? %>" data-wakeword-wakeword-value="hitchcock">
  <script>console.log("Guest ID: <%= @list.guest_id %>")</script>
  <%= turbo_stream_from @list %>

  <style>
    @keyframes breathe {
      0% {
        transform: scale(1);
        box-shadow: 0 0 15px currentColor;
      }
      35% {
        transform: scale(1.14);
        box-shadow: 0 0 30px currentColor;
      }
      45% {
        transform: scale(1.12);
        box-shadow: 0 0 28px currentColor;
      }
      75% {
        transform: scale(1.04);
        box-shadow: 0 0 18px currentColor;
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 15px currentColor;
      }
    }
    .start-circle-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      transition: transform 0.5s ease;
      cursor: pointer;
    }
    .start-circle-wrapper:hover {
      transform: scale(1.1);
    }
    .start-circle-wrapper:active {
      transform: scale(0.95);
    }
    .start-circle-wrapper:has(.shrinking),
    .start-circle-wrapper:has(.stretching) {
      cursor: default;
    }
    .start-circle-wrapper:has(.shrinking):hover,
    .start-circle-wrapper:has(.stretching):hover,
    .start-circle-wrapper:has(.shrinking):active,
    .start-circle-wrapper:has(.stretching):active {
      transform: none;
    }
    .start-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      transition: box-shadow 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 0 15px white;
      opacity: 0.8;
      animation: breathe 4.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .start-circle-wrapper:hover .start-circle {
      box-shadow: 0 0 35px white;
      opacity: 1;
    }
    .start-circle.hidden {
      display: none;
    }
    .start-circle.shrinking {
      width: 5px;
      height: 5px;
      cursor: default;
      box-shadow: 0 0 10px white;
      animation: breathe 4.5s cubic-bezier(0.4, 0, 0.6, 1) infinite paused;
      transform: scale(1);
    }
    .start-circle.stretching {
      width: 100%;
      height: 5px;
      border-radius: 2px;
      cursor: default;
      box-shadow: 0 0 10px white;
      animation: none;
    }
    .start-circle.fading {
      opacity: 0;
      transition: opacity 0.3s ease;
      animation: none;
    }
    .waveform-container {
      position: absolute;
      inset: 0;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      cursor: pointer;
    }
    .waveform-container.active {
      display: block;
    }
    .waveform-container.visible {
      opacity: 1;
    }
    .waveform-canvas {
      width: 100%;
      height: 100%;
    }
    .waveform-stop-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 32px;
      padding: 8px;
      background: #031311;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      color: white;
    }
    .waveform-stop-button svg {
      width: 100%;
      height: 100%;
      background: #031311;
      border-radius: 50%;
    }
    @media (hover: hover) {
      .waveform-container:hover .waveform-stop-button {
        opacity: 1;
      }
    }
    h1 {
      margin-bottom: clamp(5px, 1.5vw, 0.25em);
    }
    h1.heading-shrunk {
      position: fixed;
      top: 10px;
      left: 10px;
      margin: 0;
      z-index: 100;
      font-size: clamp(18px, calc(3.3px + 2.3vw), 24px);
      white-space: nowrap;
    }
    .activate-link {
      cursor: pointer;
    }
    .activate-link.hidden {
      display: none;
    }
    .activate-spinner {
      display: none;
      width: 24px;
      height: 24px;
      border: 2px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .activate-spinner.visible {
      display: block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .activate-denied {
      display: none;
      text-align: center;
    }
    .activate-denied.visible {
      display: block;
    }
    .activate-status {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .activate-silence {
      display: none;
      position: absolute;
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      text-align: center;
    }
    .activate-silence.visible {
      display: block;
    }
    .start-circle.pre-activation {
      opacity: 0;
      pointer-events: none;
    }
    .start-circle-wrapper:has(.pre-activation) {
      position: absolute;
      pointer-events: none;
    }
    .start-circle-wrapper:has(.pre-activation):hover {
      transform: none;
    }
    .start-circle.fade-in {
      transition: opacity 1.5s ease-out;
    }
  </style>

  <% if @list.pristine? %>
  <h1 data-controller="fit-text" data-task-agent-target="heading" style="display: none;">Hitchcock</h1>
  <% else %>
  <h1 class="heading-shrunk" data-task-agent-target="heading" style="display: none;">Hitchcock</h1>
  <% end %>

  <!-- Help Button, Layout Toggle, View Toggle - Top Left -->
  <div class="top-left-controls" data-controller="layout-toggle view-toggle">
    <button class="help-btn" data-action="click->help-modal#open" title="Help (?)">
      <%= lucide_icon('help-circle', class: 'help-icon') %>
    </button>
    <button class="layout-toggle-btn" data-action="click->layout-toggle#toggle" title="Toggle layout orientation">
      <svg class="layout-icon layout-icon-left" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="18" rx="1" fill="currentColor" opacity="0.3"/><rect x="14" y="3" width="7" height="18" rx="1"/></svg>
      <svg class="layout-icon layout-icon-right" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="18" rx="1" fill="currentColor" opacity="0.3"/></svg>
    </button>
    <button class="view-toggle-btn" data-action="click->view-toggle#toggle" title="Toggle list view (L)">
      <svg class="view-icon view-icon-projects" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg>
      <svg class="view-icon view-icon-list" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
    </button>
  </div>

  <!-- Top Controls - Top Right -->
  <div class="top-controls" data-controller="font project-add">
    <button class="control-btn" data-action="click->project-add#show" title="New Project (P)">
      <%= lucide_icon('folder') %>
    </button>
    <button class="control-btn" data-action="click->font#cycle" title="Change font">
      <%= lucide_icon('type') %>
    </button>
    <button class="control-btn" data-controller="eye-toggle" data-action="click->eye-toggle#toggle" data-eye-toggle-target="button">
      <%= lucide_icon('eye', class: 'eye-open', data: {eye_toggle_target: 'openIcon'}) %>
      <%= lucide_icon('eye-off', class: 'eye-closed', style: 'display: none;', data: {eye_toggle_target: 'closedIcon'}) %>
    </button>

    <!-- Project Modal -->
    <div class="project-modal" data-project-add-target="modal">
      <div class="project-modal-backdrop" data-action="click->project-add#close"></div>
      <div class="project-modal-content">
        <div class="project-modal-header">
          <h2 class="project-modal-title">New Project</h2>
          <button type="button" class="project-modal-x" data-action="click->project-add#close">
            <%= lucide_icon('x', class: 'project-modal-x-icon') %>
          </button>
        </div>

        <form data-action="submit->project-add#create">
          <div class="project-modal-field">
            <label class="project-modal-label">Project Name</label>
            <input type="text" class="project-modal-input" data-project-add-target="nameInput" placeholder="Enter project name" autofocus>
          </div>

          <div class="project-modal-field">
            <label class="project-modal-label">Sticky Color</label>
            <div class="project-modal-colors" data-project-add-target="colorPicker">
              <button type="button" class="project-color-btn color-picker-btn" data-action="click->project-add#openColorPicker" title="Custom color"></button>
              <input type="color" class="hidden-color-input" data-project-add-target="colorInput" data-action="input->project-add#customColorSelected">
              <button type="button" class="project-color-btn selected" data-color="#FEF3C7" style="background-color: #FEF3C7;"></button>
              <button type="button" class="project-color-btn" data-color="#DBEAFE" style="background-color: #DBEAFE;"></button>
              <button type="button" class="project-color-btn" data-color="#FCE7F3" style="background-color: #FCE7F3;"></button>
              <button type="button" class="project-color-btn" data-color="#D1FAE5" style="background-color: #D1FAE5;"></button>
              <button type="button" class="project-color-btn" data-color="#E0E7FF" style="background-color: #E0E7FF;"></button>
              <button type="button" class="project-color-btn" data-color="#FED7AA" style="background-color: #FED7AA;"></button>
              <button type="button" class="project-color-btn" data-color="#E9D5FF" style="background-color: #E9D5FF;"></button>
              <button type="button" class="project-color-btn" data-color="#FEE2E2" style="background-color: #FEE2E2;"></button>
              <button type="button" class="project-color-btn" data-color="#D1D5DB" style="background-color: #D1D5DB;"></button>
              <button type="button" class="project-color-btn" data-color="#BAE6FD" style="background-color: #BAE6FD;"></button>
              <button type="button" class="project-color-btn" data-color="#FDE68A" style="background-color: #FDE68A;"></button>
            </div>
          </div>

          <div class="project-modal-field">
            <label class="project-modal-label">Font Color</label>
            <div class="project-modal-font-colors" data-project-add-target="fontColorPicker">
              <button type="button" class="font-color-btn selected" data-font-color="#1a1a1a" style="background-color: #1a1a1a;" title="Black"></button>
              <button type="button" class="font-color-btn" data-font-color="#ffffff" style="background-color: #ffffff; border: 1px solid #d1d5db;" title="White"></button>
              <button type="button" class="font-color-btn" data-font-color="#dc2626" style="background-color: #dc2626;" title="Red"></button>
              <button type="button" class="font-color-btn" data-font-color="#2563eb" style="background-color: #2563eb;" title="Blue"></button>
              <button type="button" class="font-color-btn" data-font-color="#16a34a" style="background-color: #16a34a;" title="Green"></button>
              <button type="button" class="font-color-btn" data-font-color="#eab308" style="background-color: #eab308;" title="Yellow"></button>
              <button type="button" class="font-color-btn" data-font-color="#ea580c" style="background-color: #ea580c;" title="Orange"></button>
              <button type="button" class="font-color-btn" data-font-color="#9333ea" style="background-color: #9333ea;" title="Purple"></button>
            </div>
          </div>

          <div class="project-modal-field">
            <label class="project-modal-label">Preview</label>
            <div class="project-modal-preview" data-project-add-target="preview">
              <span class="project-modal-preview-text" data-project-add-target="previewText">Project Name</span>
            </div>
          </div>

          <div class="project-modal-actions">
            <button type="button" class="project-modal-cancel" data-action="click->project-add#close">Cancel</button>
            <button type="submit" class="project-modal-submit">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Zoom Controls - Bottom Right -->
  <div class="zoom-controls" data-controller="zoom">
    <button class="zoom-btn" data-action="click->zoom#zoomOut">
      <%= lucide_icon('zoom-out') %>
    </button>
    <button class="zoom-btn" data-action="click->zoom#zoomIn">
      <%= lucide_icon('zoom-in') %>
    </button>
  </div>

  <!-- Main Layout -->
  <div class="sticky-board <%= 'pre-activation' if @list.pristine? %>" data-task-agent-target="content" data-keyboard-shortcuts-target="board">
    <!-- Left Pane - Do Today (25%) -->
    <%= render "tasks/today_pane", list: @list %>

    <!-- Right Pane - Projects (75%) -->
    <div class="projects-pane">
      <!-- Voice Agent Area at top of projects -->
      <div class="voice-agent-area">
        <a class="activate-link" data-task-agent-target="activateLink" data-action="click->task-agent#activateMic click->sound#unlock">
          <div class="mic-icon-wrapper">
            <%= lucide_icon('mic', class: 'mic-icon') %>
          </div>
        </a>
        <div class="activate-status">
          <div class="activate-spinner" data-task-agent-target="activateSpinner"></div>
          <div class="activate-silence" data-task-agent-target="activateSilence">Silence. Mic Muted?</div>
        </div>
        <div class="activate-denied" data-task-agent-target="activateDenied">Mic Denied. Reset Permissions.</div>
        <div class="start-circle-wrapper">
          <div class="start-circle pre-activation" data-task-agent-target="startCircle" data-wakeword-target="trigger" data-action="click->task-agent#startAgent"></div>
        </div>
        <div class="waveform-container" data-task-agent-target="waveformContainer" data-action="click->task-agent#stopAgent">
          <canvas class="waveform-canvas" data-task-agent-target="waveformCanvas"></canvas>
          <div class="waveform-stop-button">
            <%= lucide_icon('circle-pause', class: 'waveform-stop-icon') %>
          </div>
        </div>
      </div>

      <!-- Projects Container -->
      <div class="projects-container" data-eye-toggle-target="container">
        <% @list.projects.order(:position).each do |project| %>
          <%= render "projects/project_column", project: project, list: @list, show_completed: true %>
        <% end %>
      </div>

      <!-- List View Container (hidden by default, toggled via view-toggle) -->
      <%= render "tasks/list_view", list: @list %>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="help-modal" data-help-modal-target="modal">
    <div class="help-modal-backdrop" data-action="click->help-modal#close"></div>
    <div class="help-modal-content">
      <h2 class="help-modal-title">Help</h2>

      <div class="help-modal-grid">
        <!-- Left Column - Keyboard Shortcuts -->
        <div class="help-column">
          <h3 class="help-section-title">Keyboard Shortcuts</h3>
          <div class="help-shortcuts">
            <div class="help-shortcut">
              <span class="help-key">Arrow Keys</span>
              <span class="help-desc">Navigate between stickies</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">Tab</span>
              <span class="help-desc">Switch between Do Today and projects</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">T</span>
              <span class="help-desc">Move selected sticky to Today</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">C</span>
              <span class="help-desc">Check off selected sticky</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">Cmd+Enter</span>
              <span class="help-desc">Finish editing sticky</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">1-9</span>
              <span class="help-desc">Add new sticky for each project</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">P</span>
              <span class="help-desc">Create new project</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">H</span>
              <span class="help-desc">Hide/show checked off stickies</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">L</span>
              <span class="help-desc">Toggle list view / project view</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">+/-</span>
              <span class="help-desc">Zoom in/out</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">?</span>
              <span class="help-desc">Toggle this help</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">M</span>
              <span class="help-desc">Toggle microphone on/off</span>
            </div>
            <div class="help-shortcut">
              <span class="help-key">Spacebar</span>
              <span class="help-desc">Toggle microphone on/off</span>
            </div>
          </div>
        </div>

        <!-- Right Column - Voice Commands -->
        <div class="help-column">
          <h3 class="help-section-title">Voice Commands</h3>
          <div class="help-voice">
            <div class="help-voice-activate">
              <p class="help-voice-label">Activate with:</p>
              <p class="help-voice-command">"Hitchcock"</p>
            </div>

            <div class="help-voice-item">
              <p class="help-voice-label">Create new task:</p>
              <p class="help-voice-example">"Create new task for [project name]... describe task"</p>
            </div>

            <div class="help-voice-item">
              <p class="help-voice-label">Move task to Today:</p>
              <p class="help-voice-example">"Move [task description] in [project name] to Today"</p>
            </div>

            <div class="help-voice-item">
              <p class="help-voice-label">Complete a task:</p>
              <p class="help-voice-example">"I completed [task description]"</p>
            </div>

            <div class="help-voice-item">
              <p class="help-voice-label">Add new project:</p>
              <p class="help-voice-example">"Add new project named [project name], the color is [color]"</p>
            </div>
          </div>
        </div>
      </div>

      <button class="help-modal-close" data-action="click->help-modal#close">Close</button>
    </div>
  </div>

  <!-- Footer Label -->
  <p class="footer-label">
    Made with <%= lucide_icon('heart', class: 'footer-heart') %> by Demystified.ai
  </p>
</div>
